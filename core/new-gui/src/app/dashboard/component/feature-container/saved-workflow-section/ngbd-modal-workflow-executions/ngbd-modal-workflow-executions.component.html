<div class="saved-execution-container subsection-grid-container">
  <nz-card class="workflow-section-title subsection-grid-container">
    <button (click)="activeModal.dismiss('Cross click')" aria-label="Close" class="close" type="button">
      <span aria-hidden="true"> Ã— </span>
    </button>
    <h4 class="modal-title">Execution results of Workflow: {{workflowName}}</h4>
    <nz-input-group
      [nzPrefix]="prefixPopoverButton"
      [nzSuffix]="suffixIconSearch"
      class="texera-dashboard-saved-workflow-search-box-input"
    >
      <input
        [(ngModel)]="executionSearchValue"
        autocomplete="on"
        nz-input
        placeholder="Search all executions"
        (ngModelChange)="searchInputOnChange($event)"
        type="text"
        [nzAutocomplete]="auto"
        (keyup.enter)="searchExecution()"
      />
      <ng-template #suffixIconSearch>
        <i nz-icon nzType="search"></i>
      </ng-template>
      <ng-template #popContent>
        We support the following search criteria:
        <ul>
          <li>Search by Execution Name: <strong>executionName</strong></li>
          <li>Search by Execution User: <strong>user:John</strong></li>
          <li>Search by Execution Status: <strong>status:initializing/running/paused/completed/aborted</strong></li>
        </ul>
        <strong>
          For any execution name and user name, if the name contains space, using double quotes to enclose the name is
          required.
          <br />
        </strong>
        <br />
        Example: "Untitled Execution" user:John<br />
        Meaning: Search for the execution with name Untitled Execution and run by user called John.
      </ng-template>
      <ng-template #prefixPopoverButton>
        <i
          style="vertical-align: baseline; margin-right: 10px"
          nz-icon
          nz-popover
          nzPopoverTitle="Search Instructions"
          [nzPopoverContent]="popContent"
          nzType="question-circle"
          nzTheme="outline"
        ></i>
      </ng-template>
      <nz-autocomplete
        [nzDefaultActiveFirstOption]="false"
        [nzDataSource]="filteredExecutionInfo"
        nzBackfill
        #auto
      ></nz-autocomplete>
    </nz-input-group>
  </nz-card>
  <div class="modal-body table-responsive">
    <nz-table
      *ngIf="workflowExecutionsDisplayedList"
      [nzShowSizeChanger]="true"
      [nzPageSizeOptions]="pageSizeOptions"
      [nzData]="workflowExecutionsDisplayedList"
      [nzShowPagination]="true"
      [nzPageSize]="pageSize"
      [nzPageIndex]="currentPageIndex"
      [nzTotal]="numOfExecutions"
      [nzFrontPagination]="false"
      (nzPageSizeChange)="onPageSizeChange($event)"
      (nzPageIndexChange)="onPageIndexChange($event)"
      [nzScroll]="{ x: '1000px' }"
    >
      <thead>
        <tr>
          <th
            [ngStyle]="{'width': customColumnWidth[column]}"
            *ngFor="let column of executionsTableHeaders; let i=index"
            nz-tooltip
            [nzTooltipTitle]="executionTooltip[column]"
            nzTooltipPlacement="top"
          >
            {{column}}
            <span *ngIf="column !== '' && column !== 'Status'">
              <button *ngIf="this.showORhide[i]" nz-button (click)="onHit(column, i)">
                <i nz-icon nzTheme="outline" nzType="sort-ascending"></i>
              </button>
              <button *ngIf="!this.showORhide[i]" nz-button (click)="onHit(column, i)">
                <i nz-icon nzTheme="outline" nzType="sort-descending"></i>
              </button>
            </span>
          </th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let row of workflowExecutionsDisplayedList; let i=index;">
          <tr>
            <td nzEllipsis>
              <input type="checkbox" />
            </td>
            <td nzEllipsis>
              <i
                nz-icon
                nzType="star"
                class="bookmark-icon"
                [nzTheme]="(row.bookmarked || currentlyHoveredExecution === row) ? 'fill' : 'outline'"
                (click)="onBookmarkToggle(row)"
              ></i>
            </td>
            <td nzEllipsis>
              <i nz-icon nzType="eye" class="view-icon" (click)="jumpToWorkflow(row)" nzTheme="outline"></i>
            </td>
            <td nzEllipsis>
              <nz-avatar
                [ngStyle]="{ 'background-color': setAvatarColor(row.userName) }"
                [nzGap]="1"
                [nzText]="abbreviate(row.userName || 'anonymous', false)"
                nzSize="default"
              ></nz-avatar>
            </td>
            <td nzEllipsis>
              <label
                class="execution-description"
                *ngIf="workflowExecutionsIsEditingName.indexOf(i) === -1; else customeWorkflow "
                class="workflow-name"
                >{{ abbreviate(row.name, true) }}</label
              >
              <ng-template #customeWorkflow>
                <input
                  #customName
                  (focusout)="confirmUpdateWorkflowExecutionsCustomName(row, customName.value, i)"
                  (keyup.enter)="confirmUpdateWorkflowExecutionsCustomName(row, customName.value, i)"
                  placeholder="{{ row.name }}"
                  value="{{ row.name }}"
                />
              </ng-template>
              <button
                (click)="workflowExecutionsIsEditingName.push(i)"
                nz-button
                nzSize="small"
                nzType="text"
                class="rename-icon"
              >
                <i
                  nz-icon
                  nzTheme="outline"
                  nz-tooltip
                  nzTooltipTitle='Rename Execution "{{row.name}}"'
                  nzTooltipPlacement="top"
                  nzType="edit"
                ></i>
              </button>
            </td>
            <td nzEllipsis>{{row.startingTime | date:'MM/dd/yyyy HH:mm:ss zzz'}}</td>
            <td nzEllipsis>{{row.completionTime | date:'MM/dd/yyyy HH:mm:ss zzz'}}</td>
            <td nzEllipsis>
              <i
                nz-icon
                nzTheme="outline"
                nz-tooltip
                [nzTooltipTitle]="getExecutionStatus(row.status)[0]"
                nzTooltipPlacement="top"
                [nzType]="getExecutionStatus(row.status)[1]"
                [ngStyle]="{'color': getExecutionStatus(row.status)[2]}"
                class="status-icon"
              ></i>
            </td>
            <td nzEllipsis>
              <i
                nz-icon
                nzType="delete"
                nz-tooltip
                nzTooltipTitle='Delete the Execution "{{row.name}}"'
                nzTooltipPlacement="top"
                class="trash-icon"
                (click)="onDelete(row)"
              ></i>
            </td>
            <td [nzExpand]="setOfExpandedIndex.has(i)" (nzExpandChange)="updateExpandedSet(row, i, $event)"></td>
          </tr>
          <tr [nzExpand]="setOfExpandedIndex.has(i)">
            <h5 class="sub-table-title">View Result</h5>
            <nz-table
              #basicTable
              [nzData]="workflowExecutionsDisplayedList"
              [nzShowPagination]="false"
              [nzScroll]="{ x: '1000px' }"
            >
              <thead>
                <tr>
                  <th nzWidth="100px">Sink Name</th>
                  <th nzWidth="100px">View Details</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let sink of getResultKeys(row.result); let j=index;">
                  <tr>
                    <td nzEllipsis>View Result {{j+1}}</td>
                    <td
                      [nzExpand]="setOfSubExpandedIndex.has(convertSubTableIndex(i, j))"
                      (nzExpandChange)="updateSubExpandedSet(i, j, $event)"
                      (click)="retrieveResult(sink)"
                    ></td>
                  </tr>
                  <tr [nzExpand]="setOfSubExpandedIndex.has(convertSubTableIndex(i, j))">
                    <h5 class="sub-table-title">Sample Row</h5>
                    <nz-table
                      #detailTable
                      [nzData]="workflowExecutionsDisplayedList"
                      [nzShowPagination]="false"
                      [nzScroll]="{ x: '500px' }"
                    >
                      <thead>
                        <tr>
                          <th
                            class="sample-row-title"
                            nzWidth="100px"
                            *ngFor="let column of getData(resultRow[sink], 'key')"
                          >
                            {{column}}
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td nzEllipsis *ngFor="let cell of getData(resultRow[sink], 'value')">
                            {{cell !== null ? cell : "Null Data"}}
                          </td>
                        </tr>
                      </tbody>
                    </nz-table>
                    <h6>Number of rows: {{digitFormatter(resultCount[sink], 2)}}</h6>
                  </tr>
                </ng-container>
              </tbody>
            </nz-table>
          </tr>
        </ng-container>
      </tbody>
    </nz-table>
  </div>
</div>
